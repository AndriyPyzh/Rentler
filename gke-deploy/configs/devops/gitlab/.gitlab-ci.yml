image: ap2412/gcloud-maven

stages:
  - check
  - gcloud-init
  - build
  - test
  - verify
  - install

cache:
  paths:
    - .m2/repository
    - target

default:
  before_script:
    - echo "gcloud init"
    - echo $GOOGLE_APPLICATION_CREDENTIALS > gcloud-service-key.json # Google Cloud service accounts
    - gcloud auth activate-service-account --key-file gcloud-service-key.json
    - gcloud config set project $PROJECT_ID

check_job:
  stage: check
  script:
    - echo "check job - should always start"
  rules:
    - if: '"$VAR_FOR_CHECK_JOB"'

build_job:
  stage: build
  tags:
    - docker
  script:
    - echo "Maven package started"
    - "mvn clean package -DskipTests -Pdev -f $RENTLER_MODULE/pom.xml"
  rules:
    - if: '$RENTLER_MODULE == "rentler-helper"
        || $RENTLER_MODULE == "account-service"
        || $RENTLER_MODULE == "apartment-service"
        || $RENTLER_MODULE == "notification-service"
        || $RENTLER_MODULE == "auth-service"
        || $RENTLER_MODULE == "api-gateway"'

test_job:
  stage: test
  tags:
    - docker
  script:
    - echo "Maven test started"
    - "mvn test -Pdev -f $RENTLER_MODULE/pom.xml"
  rules:
    - if: '$RENTLER_MODULE == "rentler-helper"
        || $RENTLER_MODULE == "account-service"
        || $RENTLER_MODULE == "apartment-service"
        || $RENTLER_MODULE == "notification-service"
        || $RENTLER_MODULE == "auth-service"
        || $RENTLER_MODULE == "api-gateway"'

verify_job:
  stage: verify
  tags:
    - docker
  script:
    - echo "Maven verify started"
    - "mvn verify -Pdev -f $RENTLER_MODULE/pom.xml"
  rules:
    - if: '$RENTLER_MODULE == "rentler-helper"
        || $RENTLER_MODULE == "account-service"
        || $RENTLER_MODULE == "apartment-service"
        || $RENTLER_MODULE == "notification-service"
        || $RENTLER_MODULE == "auth-service"
        || $RENTLER_MODULE == "api-gateway"'

install_job:
  stage: install
  tags:
    - docker
  script:
    - echo "Maven install started"
    - "mvn deploy -DskipTests -Pdev -f $RENTLER_MODULE/pom.xml"
  rules:
    - if: '$RENTLER_MODULE == "rentler-helper"
        || $RENTLER_MODULE == "account-service"
        || $RENTLER_MODULE == "apartment-service"
        || $RENTLER_MODULE == "notification-service"
        || $RENTLER_MODULE == "auth-service"
        || $RENTLER_MODULE == "api-gateway"'


